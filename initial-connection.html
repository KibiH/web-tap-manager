<!DOCTYPE html>
<html>
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600" rel="stylesheet">
  <head>
    <meta charset="utf-8">

    <title>Tap Manager</title>

    <style>
      html {
        font-family: Open Sans;
      }

      h1 {
          font-family: "Open Sans";
          font-size: 44px;
          font-style: normal;
          font-variant: normal;
          font-weight: 300;
          line-height: 26.4px;
          color: #707070;
         }

      h2 {
           font-family: "Open Sans";
           font-size: 24px;
           font-style: Semibold;
           font-variant: normal;
           font-weight: 800;
           line-height: 15.4px;
           color: #707070;
         }

      h3 {
              font-family: "Open Sans";
              font-size: 18px;
              font-style: Semibold;
              font-variant: normal;
              font-weight: 800;
              line-height: 15.4px;
              color: #707070;
         }

        h4 {
                 font-family: "Open Sans";
                 font-size: 20px;
                 font-style: normal;
                 font-variant: normal;
                 font-weight: 700;
                 line-height: 15.4px;
                 color: #707070;
            }

       p {
            font-family: "Open Sans";
            font-size: 14px;
            font-style: normal;
            font-variant: normal;
            font-weight: 400;
            line-height: 20px;
         }

        blockquote {
            font-family: "Open Sans";
            font-size: 21px;
            font-style: normal;
            font-variant: normal;
            font-weight: 400;
            line-height: 30px;
         }

        pre {
            font-family: "Open Sans";
            font-size: 13px;
            font-style: normal;
            font-variant: normal;
            font-weight: 400;
            line-height: 18.5714px;
      }

      button {
          background-color: #33A2DC;
          color: white;
          font-family: "Open Sans";
          font-size: 21px;
          font-style: Semibold;
          font-variant: Semibold;
          font-weight: 600;
          line-height: 30px;
          border: none;
          padding: 5px;
      }

      body {
        width: 50%;
        max-width: 800px;
        min-width: 480px;
        margin: 0 auto;
        background-color: #F2F3F7;
      }

      .settingItem {
          display: flex;
          justify-content: space-between;
          border: 1px solid #DFE1E8;
          padding: 5px;margin:10px;
      }

      .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 31px;
      }

      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #C7CAD5;
        -webkit-transition: .4s;
        transition: .4s;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 2px;
        /* bottom: 1px; */
        top: 2px;
        /* right: 1px; */
        background-color: white;
        -webkit-transition: .4s;
        transition: .4s;
      }

      input:checked + .slider {
        background-color: #33A2DC;
      }

      input:focus + .slider {
        box-shadow: 0 0 1px #33A2DC;
      }

      input:checked + .slider:before {
        -webkit-transform: translateX(20px);
        -ms-transform: translateX(20px);
        transform: translateX(20px);
      }

      /* Rounded sliders */
      .slider.round {
        border-radius: 30px;
      }

      .slider.round:before {
        border-radius: 50%;
      }

      .slidecontainer {
        width: 100%; /* Width of the outside container */
      }

      /* The slider itself */
      .scaler {
        -webkit-appearance: none;  /* Override default CSS styles */
        appearance: none;
        width: 100%; /* Full-width */
        height: 25px; /* Specified height */
        background: #d3d3d3; /* Grey background */
        border-radius: 24px;
        outline: none; /* Remove outline */
        opacity: 0.7; /* Set transparency (for mouse-over effects on hover) */
        -webkit-transition: .2s; /* 0.2 seconds transition on hover */
        transition: opacity .2s;
      }

      /* Mouse-over effects */
      .scaler:hover {
        opacity: 1; /* Fully shown on mouse-over */
      }

      /* The slider handle (use -webkit- (Chrome, Opera, Safari, Edge) and -moz- (Firefox) to override default look) */
      .scaler::-webkit-slider-thumb {
        -webkit-appearance: none; /* Override default look */
        appearance: none;
        border-radius: 24px;
        width: 25px; /* Set a specific slider handle width */
        height: 25px; /* Slider handle height */
        background: #04AA6D; /* Green background */
        cursor: pointer; /* Cursor on hover */
      }

      .scaler::-moz-range-thumb {
        width: 25px; /* Set a specific slider handle width */
        height: 25px; /* Slider handle height */
        border-radius: 24px;
        background: #04AA6D; /* Green background */
        cursor: pointer; /* Cursor on hover */
      }

    </style>
  </head>
  <body>
    <h1 id="title">Welcome to TapManager Web</h1>
    <h2 id="tapName"></h2>
    <!-- <p>When you press the button we will search for Tap devices nearby</p> -->

    <button id="searchDevicesBtn">Search for Tap </button>

    <div id="notFound"> No devices found, please try again</div>
    <p>
    <h3 id="general"> General:</h3>
    <div class="settingItem" id="checkForUpdates">
        <div>Check for updates</div>
        <button id="checkButton">Check</button>
    </div>

    <div class="settingItem" id="leftHandedBox">
        <h4>Left Handed</h4>
        <label class="switch">
            <input type="checkbox" id="leftHandedSwitch">
            <span class="slider round"><span>
        </label>

        <dialog id="leftHandedDialog">
            <form method="dialog">
                <h1>Left-handed</h1>
                <label>You're about to switch your TAP to left-handed usage.</label>
                <menu>
                    <button value="cancel">Cancel</button>
                    <button value="default">Continue</button>
                </menu>
            </form>
        </dialog>

        <dialog id="rightHandedDialog">
            <form method="dialog">
                <h1>Right-handed</h1>
                <label>You're about to switch your TAP to right-handed usage.</label>
                <menu>
                    <button value="cancel">Cancel</button>
                    <button value="default">Continue</button>
                </menu>
            </form>
        </dialog>

    </div>

    <div class="settingItem" id="vibrationBox">
        <div>Vibration</div>
        <label class="switch">
            <input type="checkbox" id="vibrationSwitch">
            <span class="slider round"><span>
        </label>

        <dialog id="vibrationsOffDialog">
            <form method="dialog">
                <h1>Vibration</h1>
                <label>You're about to turn off vibrations on your TAP.</label>
                <menu>
                    <button value="cancel">Cancel</button>
                    <button value="default">Continue</button>
                </menu>
            </form>
        </dialog>
    </div>

    <div class="settingItem" id="standbyModeBox">
        <div>Standby Mode Enabled</div>
        <label class="switch">
            <input type="checkbox" id="standbyEnabledSwitch">
            <span class="slider round"><span>
        </label>
        <p>Double Tap 4 fingers (index to pinky) in mouse mode to toggle "standby mode"</p>

        <dialog id="standbyOnDialog">
            <form method="dialog">
                <h1>Standby Mode</h1>
                <label>You're about to enable standby mode. Standby mode keeps your Tap connected without sending input to your device.</label>
                <menu>
                    <button value="cancel">Cancel</button>
                    <button value="default">Continue</button>
                </menu>
            </form>
        </dialog>
    </div>

    <div class="settingItem" id="doubleTapTimeoutBox">
        <div>Double Tap Timeout</div>
        <div class="slidecontainer">
            <input type="range" min="1" max="10" value="5" class="scaler" id="doubleTapTimeoutSlider">
        </div>
    </div>

    <div class="settingItem" id="sleepAfterBox">
        <div>Sleep after:</div>
        <select name="minutes" id="sleepSelector">
            <option value="1">1 minute</option>
            <option value="2">2 minutes</option>
            <option value="5">5 minutes</option>
            <option value="10">10 minutes</option>
            <option value="15">15 minutes</option>
        </select>
    </div>

    <div id="text">Text:</div>

    <div class="settingItem" id="autoCorrectionBox">
        <div>Auto Correction</div>
        <label class="switch">
            <input type="checkbox" id="autoCorrectionSwitch">
            <span class="slider round"><span>
        </label>
    </div>

    <div id="input">Input:</div>

    <div class="settingItem" id="mouseOnlyBox">
        <div>Mouse Only</div>
        <label class="switch">
            <input type="checkbox" id="mouseOnlySwitch">
            <span class="slider round"><span>
        </label>

        <dialog id="mouseOnlyDialog">
            <form method="dialog">
                <h1>Mouse Only</h1>
                <label>you are about to disable keyboard inputs on your TAP</label>
                <menu>
                    <button value="cancel">Cancel</button>
                    <button value="default">Continue</button>
                </menu>
            </form>
        </dialog>
    </div>

    <div class="settingItem" id="keyboardOnlyBox">
        <div>Keyboard Only</div>
        <label class="switch">
            <input type="checkbox" id="keyboardOnlySwitch">
            <span class="slider round"><span>
        </label>

        <dialog id="keyboardOnlyDialog">
            <form method="dialog">
                <h1>Mouse Only</h1>
                <label>you are about to disable mouse inputs on your TAP</label>
                <menu>
                    <button value="cancel">Cancel</button>
                    <button value="default">Continue</button>
                </menu>
            </form>
        </dialog>

    </div>

    <div class="settingItem" id="mouseAndKeyboardBox">
        <div>Mouse and Keyboard</div>
        <label class="switch">
            <input type="checkbox" id="mouseAndKeyboardSwitch">
            <span class="slider round"><span>
        </label>
    </div>

    <div id="customMapping">Custom Tap Mapping:</div>

    <!--this isn't going to work yet -->
    <div class="settingItem" id="tapMappingBox">
        <div>Tap mapping</div>
        <button id="mappingButton">Mapping</button>
    </div>

    <div id="mouse"> Mouse:</div>

    <div class="settingItem" id="mouseSensitivityBox">
        <div>Mouse Sensitivity</div>
        <div class="slidecontainer">
            <input type="range" min="1" max="10" value="5" class="scaler" id="mouseSensitivitySlider">
        </div>
    </div>

    <div class="settingItem" id="scrollSensitivityBox">
        <div>Scroll Sensitivity</div>
        <div class="slidecontainer">
            <input type="range" min="1" max="10" value="5" class="scaler" id="scrollSensitivitySlider">
        </div>
    </div>

    <div class="settingItem" id="scrollDirectionFlipBox">
        <div>Scroll Direction Flip</div>
        <label class="switch">
            <input type="checkbox" id="scrollDirectionFlipSwitch">
            <span class="slider round"><span>
        </label>
    </div>

    <div id="development"> Development:</div>

    <div class="settingItem" id="developerModeBox">
        <div>Developer Mode</div>
        <label class="switch">
            <input type="checkbox" id="developerModeSwitch">
            <span class="slider round"><span>
        </label>

        <dialog id="developerModeDialog">
            <form method="dialog">
                <h1>Developer Mode</h1>
                <label>Developer mode will configure this Tap</label>
                <label>for use with extended SDK features that</label>
                <label>require a different BLE configuration.</label>
                <label>Some devices may experience connectivity</label>
                <label>issues with this Tap</label>
                <menu>
                    <button value="cancel">Cancel</button>
                    <button value="default">Continue</button>
                </menu>
            </form>
        </dialog>

        <dialog id="developerModeChangedDialog">
            <form method="dialog">
                <h1>Developer Mode</h1>
                <label>Please restart your Tap to apply this setting</label>
                <menu>
                    <button value="default">Continue</button>
                </menu>
            </form>
        </dialog>

    </div>


    <script>
        /* BitArray PRIVATE STATIC CONSTANTS */
        BitArray._ON = 1;
        BitArray._OFF = 0;

        function BitArray(size, bits) {
            // array of bits
            this.m_bits = new Array();
            if (bits && bits.length) {
                for (var i = 0; i < bits.length; i++) {
                    this.m_bits.push(bits[i] ? BitArray._ON : BitArray._OFF);
                }
            } else if (!isNaN(bits)) {
                this.m_bits = BitArray.shred(bits).m_bits;
            }
            if (size && this.m_bits.length != size) {
                if (this.m_bits/length < size) {
                    for (var i = this.m_bits.length; i < size; i++) {
                        this.m_bits.push(BitArray._OFF);
                    }
                } else {
                    for (var i = size; 1 > this.m_bits.length; i--) {
                        this.m_bits.pop();
                    }
                }
            }
            return this.m_bits;
        }

        BitArray.prototype.getLength - function () { return this.m_bits.length; };

        BitArray.prototype.getAt = function(index) {
            if (index < this.m_bits.length) {
                return this.m_bits[index];
            }
            return null;
        };

        BitArray.prototype.setAt = function(index, value) {
            if (index < this.m_bits.length) {
                this.m_bits[index] = value ? BitArray._ON : BitArray._OFF;
            }
        };

        BitArray.prototype.reize = function(newSize) {
            var tmp = new Array();
            for (var i = 0; i < newSize; i++) {
                if (i < this.m_bits.length) {
                    tmp.push(this.m_bits[i]);
                } else {
                    tmp.push(BitArray._OFF);
                }
            }
            this.m_bits = tmp;
        };

        BitArray.prototype.toString = function() {
            var s = new String();
            for (var i = 0; i < this.m_bits.length; i++) {
                s = s.concat(this.m_bits[i] === BitArray._ON ? "1" : "0");
            }
        };

        // maybe add a function to convert a range of bits to a number
        BitArray.prototype.toNumber = function () {
            var pow = 0;
            var n = 0;
            for (var i = this.m_bits.length - 1; i >= 0; i--) {
                if (this.m_bits[i] === BitArray._ON) {
                    n += Math.pow(2, pow);
                }
                pow++;
            }
            return n;
        };

        // Convert a number into a bit array
        BitArray.shred = function (number) {
            var bits = new Array();
            var q = number;
            do {
                bits.push(q % 2);
                q = Math.floor(q / 2);
            } while (q > 0);
            return new BitArray(bits.length, bits.reverse());
        };

        BitArray.shredWithSize = function (number, size) {
            var bits = new Array();
            var q = number;
            do {
                bits.push(q % 2);
                q = Math.floor(q / 2);
            } while (q > 0);

            while (bits.length < size) {
                bits.push(0);
            }
            // not going to reverse so the bit0 will be at position 0
            return new BitArray(bits.length, bits);
        };

        function saveSettings() {
            // we need to put all the settings back into the bytes
            var sendingArray = new Uint8Array(20);
            for (var i = 0; i < 20; i++) {
                sendingArray[i] = 0;
            }

            // var arrayStr = "";
            // for (var i = 0; i < 20; i++) {
            //     arrayStr += sendingArray[i];
            //     arrayStr += ".";
            // }
            // console.log("contents at beginning = " + arrayStr);

            var firstByte = 0;
            firstByte += (leftHanded);
            var vibrationOff = !vibration;
            firstByte += (vibrationOff * 2);
            firstByte += (mouseOnly * 4);
            firstByte += (voiceOver * 8);
            firstByte += (autoCorrection * 16);
            firstByte += (scrollDirectionFlip * 32);
            firstByte += (keyboardOnly * 64);
            firstByte += (standbyModeEnabled * 128);
            console.log("whole First byte is: " + firstByte);
            sendingArray[0] = firstByte;

            var secondByte = 0;
            secondByte += mouseSensitivity;
            secondByte += (scrollSensitivity * 16);
            console.log("whole second byte is " + secondByte);
            sendingArray[1] = secondByte;

            var thirdByte = 0;
            thirdByte += doubleTapTimeout;
            thirdByte += (airMouse * 16);
            thirdByte += (airMouseMedia * 32);
            thirdByte += (airMouseTv * 64);
            console.log("whole third byte is " + thirdByte);
            sendingArray[2] = thirdByte;

            var fourthByte = 0;
            fourthByte += sleepAfterValue;
            fourthByte += (developerMode * 64);
            console.log("whole fourth byte is " + fourthByte);
            sendingArray[3] = fourthByte;

            // console.log("array here is " + sendingArray);

            // console.log('> Characteristic UUID:  ' + savedSettingsCharacteristic.uuid);

            savedSettingsCharacteristic.writeValueWithResponse(sendingArray).then( stuff=> {
                // console.log("here it is " + stuff);
            }).catch (error => {
                console.log('Argh! Cant send!!! ' + error.message);
                console.log('it is all over now');
            });

        }

        function disconnected() {
            title.innerHTML = "Welcome to TapManager Web";
            searchBtn.style.display = "block";
            tapName.style.display = "none";

            notFoundTxt.style.display = "block";

            generalHeader.style.display = "none";
            // checkUpdatesBox.style.display = "block";
            leftHandBox.style.display = "none";
            vibrationBox.style.display = "none";
            standbyBox.style.display = "none";
            doubleTapTimeoutBox.style.display = "none";
            sleepAfterBox.style.display = "none";
            textHeader.style.display = "none";
            autoCorrectionBox.style.display = "none";
            inputHeader.style.display = "none";
            mouseOnlyBox.style.display = "none";
            keyboardOnlyBox.style.display = "none";
            mouseAndKeyboardBox.style.display = "none";
            // customMappingHeader.style.display = "none";
            // tapMappingBox.style.display = "none";
            mouseHeader.style.display = "none";
            mouseSensitivityBox.style.display = "none";
            scrollSensitivityBox.style.display = "none";
            scrollDirectionFlipBox.style.display = "none";
            developmentHeader.style.display = "none";
            developerModeBox.style.display = "none";
        }

        let DEVICE_INFORMATION = '0000180a-0000-1000-8000-00805f9b34fb';
        let BATTERY_SERVICE    = '0000180f-0000-1000-8000-00805f9b34fb';
        let TAP_SERVICE        = 'c3ff0001-1d8b-40fd-a56f-c7bd5d0f3370';

        let FIRMWARE_REVISION_STRING = '00002a26-0000-1000-8000-00805f9b34fb';
        let HARDWARE_REVISION_STRING = '00002a27-0000-1000-8000-00805f9b34fb';
        let BATTERY_LEVEL = '00002a19-0000-1000-8000-00805f9b34fb';
        let SETTINGS      = 'c3ff0002-1d8b-40fd-a56f-c7bd5d0f3370';
        // Add a global error event listener early on in the page load, to help ensure that browsers
        // which don't support specific functionality still end up displaying a meaningful message.
        window.addEventListener('error', function(error) {
            if (ChromeSamples && ChromeSamples.setStatus) {
              console.error(error);
              ChromeSamples.setStatus(error.message + ' (Your browser may not support this feature.)');
              error.preventDefault();
            }
        });

        // all the variables here
        var leftHanded = false;
        var vibration = true;
        var standbyModeEnabled = false;
        var doubleTapTimeout = 5;
        var airMouse = false;
        var airMouseMedia = false;
        var airMouseTv = false;
        var sleepAfterValue = 2;
        var autoCorrection = false;
        var mouseOnly = false;
        var voiceOver = false;
        var keyboardOnly = false;
        var mouseAndKeyboard = true;
        var mouseSensitivity = 5;
        var scrollSensitivity = 5;
        var scrollDirectionFlip = false;
        var developerMode = false;

        var title = document.getElementById('title');

        var deviceName;
        var tapName = document.getElementById('tapName');
        tapName.style.display = "none";

        var notFoundTxt = document.getElementById('notFound');
        notFoundTxt.style.display = "none";

        var generalHeader = document.getElementById('general');
        generalHeader.style.display = "none";

        var checkUpdatesBox = document.getElementById('checkForUpdates');
        checkUpdatesBox.style.display = "none";

        var leftHandBox = document.getElementById('leftHandedBox');
        leftHandBox.style.display = "none";
        var leftHandedSwitch = document.getElementById('leftHandedSwitch');

        var vibrationBox = document.getElementById('vibrationBox');
        vibrationBox.style.display = "none";
        var vibrationSwitch = document.getElementById('vibrationSwitch');

        var standbyBox = document.getElementById('standbyModeBox');
        standbyBox.style.display = "none";
        var standbySwitch = document.getElementById('standbyEnabledSwitch');

        var doubleTapTimeoutBox = document.getElementById('doubleTapTimeoutBox');
        doubleTapTimeoutBox.style.display = "none";
        var doubleTapSlider = document.getElementById('doubleTapTimeoutSlider');

        var sleepAfterBox = document.getElementById('sleepAfterBox');
        sleepAfterBox.style.display = "none";
        var sleepSelector = document.getElementById('sleepSelector');

        var textHeader = document.getElementById('text');
        textHeader.style.display = "none";

        var autoCorrectionBox = document.getElementById('autoCorrectionBox');
        autoCorrectionBox.style.display = "none";
        var autoCorrectionSwitch = document.getElementById('autoCorrectionSwitch');

        var inputHeader = document.getElementById('input');
        inputHeader.style.display = "none";

        var mouseOnlyBox = document.getElementById('mouseOnlyBox');
        mouseOnlyBox.style.display = "none";
        var mouseOnlySwitch = document.getElementById('mouseOnlySwitch');

        var keyboardOnlyBox = document.getElementById('keyboardOnlyBox');
        keyboardOnlyBox.style.display = "none";
        var keyboardOnlySwitch = document.getElementById('keyboardOnlySwitch');

        var mouseAndKeyboardBox = document.getElementById('mouseAndKeyboardBox');
        mouseAndKeyboardBox.style.display = "none";
        var mouseAndKeyboardSwitch = document.getElementById('mouseAndKeyboardSwitch');

        var customMappingHeader = document.getElementById('customMapping');
        customMappingHeader.style.display = "none";
        var tapMappingBox = document.getElementById('tapMappingBox');
        tapMappingBox.style.display = "none";
        var mappingButton = document.getElementById('mappingButton');

        var mouseHeader = document.getElementById('mouse');
        mouseHeader.style.display = "none";
        var mouseSensitivityBox = document.getElementById('mouseSensitivityBox');
        mouseSensitivityBox.style.display = "none";
        var mouseSensitivitySlider = document.getElementById('mouseSensitivitySlider');

        var scrollSensitivityBox = document.getElementById('scrollSensitivityBox');
        scrollSensitivityBox.style.display = "none";
        var scrollSensitivitySlider = document.getElementById('scrollSensitivitySlider');

        var scrollDirectionFlipBox = document.getElementById('scrollDirectionFlipBox');
        scrollDirectionFlipBox.style.display = "none";
        var scrollDirectionFlipSwitch = document.getElementById('scrollDirectionFlipSwitch');

        var developmentHeader = document.getElementById('development');
        developmentHeader.style.display = "none";
        var developerModeBox = document.getElementById('developerModeBox');
        developerModeBox.style.display = "none";
        var developerModeSwitch = document.getElementById('developerModeSwitch');

        var leftHandedDialog = document.getElementById('leftHandedDialog');
        var rightHandedDialog = document.getElementById('rightHandedDialog');
        var vibrationsOffDialog = document.getElementById('vibrationsOffDialog');
        var standbyOnDialog = document.getElementById('standbyOnDialog');
        var mouseOnlyDialog = document.getElementById('mouseOnlyDialog');
        var keyboardOnlyDialog = document.getElementById('keyboardOnlyDialog');
        var developerModeDialog = document.getElementById('developerModeDialog');
        var developerModeChangedDialog = document.getElementById('developerModeChangedDialog');

        var savedDevice;
        var savedServer;
        var savedSettingsCharacteristic;

        var  searchBtn = document.getElementById('searchDevicesBtn')
        searchBtn.addEventListener('click', function() {
            notFoundTxt.style.display = "none";
            let filters = [];
            // this UUID is the specific TAP UUID
            filters.push({services: [TAP_SERVICE]});

            let optionalServices = [];
            optionalServices.push(BATTERY_SERVICE, DEVICE_INFORMATION);

            let options = {};
            options.filters = filters;
            options.optionalServices = optionalServices;

            console.log('Requesting TAP device...');

            navigator.bluetooth.requestDevice(options).then(device => {
                deviceName = device.name;
                console.log('> Name:       ' + device.name);
                console.log('> Id:         ' + device.id);
                console.log('> Connected:  ' + device.gatt.connected);
                savedDevice = device;
                return device;
            }).then (device => {
                console.log('Here we are connecting to ' + device.name);
                device.addEventListener('gattserverdisconnected', function() {
                    console.log("disconnected");
                    disconnected();
                });
                return device.gatt.connect();
            }).then (server => {
                // console.log('Connected to device: ' + server.device.name);
                // console.log('Getting device info service');
                savedServer = server;
                return server.getPrimaryService(DEVICE_INFORMATION);
            }).then(service => {
                // console.log('Getting firmware string characteristic');
                return service.getCharacteristic(FIRMWARE_REVISION_STRING);
            }).then (characteristic => {
                // console.log('Reading characteristic info:');
                return characteristic.readValue();
            }).then ( value => {
                var decoder = new TextDecoder("utf-8");
                let decoded = decoder.decode(value);
                let stringValue = value.toString();
                // console.log('> Firmware string is ' + decoded);
                return savedServer;
            }).then (server => {
                // console.log('Getting device info service again...');
                return server.getPrimaryService(DEVICE_INFORMATION);
            }).then (service => {
                // console.log('Getting hardware string characteristic');
                return service.getCharacteristic(HARDWARE_REVISION_STRING);
            }).then (characteristic => {
                // console.log('Reading characteristic info...');
                return characteristic.readValue();
            }).then(value => {
                var decoder = new TextDecoder("utf-8");
                let decoded = decoder.decode(value);
                let stringValue = value.toString();
                // console.log('> Hardware string is ' + decoded);
                return savedServer;
            }).then (server => {
                // console.log('Getting TAP service ...');
                return server.getPrimaryService(TAP_SERVICE);
            }).then (service => {
                // console.log('Getting settings characteristic');
                return service.getCharacteristic(SETTINGS);
            }).then (characteristic => {
                // console.log('Reading settings info...');
                savedSettingsCharacteristic = characteristic;
                return characteristic.readValue();
            }).then(value => {
                // console.log("value here is " + value);
                // we should have an array of values here to decoded
                let firstByte = value.getUint8(0);
                var firstByteArray = new BitArray.shredWithSize(firstByte, 8);
                console.log("first byte is: " + firstByte);
                console.log('got the first bitarray: ' + firstByteArray);
                // console.log('got the first bitarray2: ' + firstByteArray.toString());
                leftHanded = (firstByteArray[0] === BitArray._ON);
                // console.log('Left handed = ' + leftHanded);
                vibrationOff = (firstByteArray[1] === BitArray._ON);
                vibration = !vibrationOff;
                // console.log('vibration off = ' + vibrationOff);
                // console.log('vibration = ' + vibration);
                mouseOnly = (firstByteArray[2] === BitArray._ON);
                // console.log('mouseOnly = ' + mouseOnly);
                voiceOver = (firstByteArray[3] === BitArray._ON);
                // console.log('voiceOver = ' + voiceOver);
                autoCorrection = (firstByteArray[4] === BitArray._ON);
                // console.log('autoCorrection = ' + autoCorrection);
                scrollDirectionFlip = (firstByteArray[5] === BitArray._ON)
                // console.log('scrollDirectionFlip = ' + scrollDirectionFlip);
                keyboardOnly = (firstByteArray[6] === BitArray._ON);
                // console.log('keyboardOnly = ' + keyboardOnly);
                standbyModeEnabled = (firstByteArray[7] === BitArray._ON);
                // console.log('standbyEnabled = ' + standbyModeEnabled);

                let secondByte = value.getUint8(1);
                console.log("second byte is: " + secondByte);
                let secondByteArray = new BitArray.shredWithSize(secondByte, 8);
                // console.log('got the second bitarray: ' + secondByteArray);
                mouseSensitivity = 0;
                var multiplier = 1;
                for (var n = 0; n < 4; n++) {
                    mouseSensitivity += (secondByteArray[n] * multiplier);
                    multiplier = multiplier * 2;
                }
                console.log('mouseSensitivity = ' + mouseSensitivity);

                scrollSensitivity = 0;
                multiplier = 1;
                for (var n = 4; n < 8; n++) {
                    scrollSensitivity += (secondByteArray[n] * multiplier);
                    multiplier = multiplier * 2;
                }
                console.log('scrollSensitivity = ' + scrollSensitivity);

                let thirdByte = value.getUint8(2);
                console.log("third byte is: " + thirdByte);
                let thirdByteArray = new BitArray.shredWithSize(thirdByte, 8);
                // console.log('got the third bitarray: ' + thirdByteArray);
                doubleTapTimeout = 0;
                multiplier = 1;
                for (var n = 0; n < 4; n++) {
                    doubleTapTimeout += (thirdByteArray[n] * multiplier);
                    multiplier = multiplier * 2;
                }
                // console.log('doubleTapTimeout = ' + doubleTapTimeout);

                airMouse = (thirdByteArray[4] === BitArray._ON);
                // console.log('airMouse = ' + airMouse);
                airMouseMedia = (thirdByteArray[5] === BitArray._ON);
                // console.log('airMouseMedia = ' + airMouseMedia);
                airMouseTv = (thirdByteArray[6] === BitArray._ON);
                // console.log('airMouseTv = ' + airMouseTv);

                let fourthByte = value.getUint8(3);
                console.log("fourth byte is: " + fourthByte);
                let fourthByteArray = new BitArray.shredWithSize(fourthByte, 8);
                // console.log('got the fourth bitarray: ' + fourthByteArray);
                sleepAfterValue = 0;
                multiplier = 1;
                for (var n = 0; n < 6; n++) {
                    sleepAfterValue += (fourthByteArray[n] * multiplier);
                    multiplier = multiplier * 2;
                }
                // console.log('sleepTimeout = ' + sleepAfterValue);
                developerMode = (fourthByteArray[6] === BitArray._ON);
                // console.log('developerMode = ' + developerMode);

                title.innerHTML = "Tap Strap connected";
                searchBtn.style.display = "none";
                tapName.style.display = "block";
                tapName.innerHTML = deviceName;
                // let stringValue = value.toString();
                generalHeader.style.display = "block";
                // checkUpdatesBox.style.display = "block";
                leftHandBox.style.display = "block";
                leftHandedSwitch.checked = leftHanded;
                vibrationBox.style.display = "block";
                vibrationSwitch.checked = vibration;
                standbyBox.style.display = "block";
                standbySwitch.checked = standbyModeEnabled;
                doubleTapTimeoutBox.style.display = "block";
                doubleTapTimeoutSlider.value = doubleTapTimeout;
                sleepAfterBox.style.display = "block";
                sleepSelector.value = sleepAfterValue;
                textHeader.style.display = "block";
                autoCorrectionBox.style.display = "block";
                autoCorrectionSwitch.checked = autoCorrection;
                inputHeader.style.display = "block";
                mouseOnlyBox.style.display = "block";
                mouseOnlySwitch.checked = mouseOnly;
                keyboardOnlyBox.style.display = "block";
                keyboardOnlySwitch.checked = keyboardOnly;
                mouseAndKeyboardBox.style.display = "block";
                mouseAndKeyboard = !(mouseOnly || keyboardOnly);
                mouseAndKeyboardSwitch.checked = mouseAndKeyboard;
                // customMappingHeader.style.display = "block";
                // tapMappingBox.style.display = "block";
                mouseHeader.style.display = "block";
                mouseSensitivityBox.style.display = "block";
                mouseSensitivitySlider.value = mouseSensitivity;
                scrollSensitivityBox.style.display = "block";
                scrollSensitivitySlider.value = scrollSensitivity;
                scrollDirectionFlipBox.style.display = "block";
                scrollDirectionFlipSwitch.checked = scrollDirectionFlip;
                developmentHeader.style.display = "block";
                developerModeBox.style.display = "block";
                developerModeSwitch.checked = developerMode;
                console.log('> Go to waiting loop');
                return value;
            }).then(value => {
                // ok let's set up the work to set the values when people change
                // values on the screen
                leftHandedSwitch.oninput = function() {
                    leftHanded = this.checked;

                    if (leftHanded) {
                        // we just set it to true, need to ask in a dialog
                        leftHandedDialog.showModal();
                        leftHandedDialog.addEventListener('close', function onClose() {
                            if (leftHandedDialog.returnValue == 'cancel') {
                                console.log("we got cancelled!");
                                leftHandedSwitch.checked = false;
                                leftHanded = false
                            } else {
                                console.log("lefthanded now equals: " + leftHanded);
                                saveSettings();
                            }
                        });
                    } else {
                        rightHandedDialog.showModal();
                        rightHandedDialog.addEventListener('close', function onClose() {
                            if (rightHandedDialog.returnValue == 'cancel') {
                                console.log("we got cancelled!");
                                leftHandedSwitch.checked = true;
                                leftHanded = true
                            } else {
                                console.log("lefthanded now equals: " + leftHanded);
                                saveSettings();
                            }
                        });
                    }
                }

                vibrationSwitch.oninput = function() {
                    vibration = this.checked;

                    if (!vibration) {
                        // we just set it to true, need to ask in a dialog
                        vibrationsOffDialog.showModal();
                        vibrationsOffDialog.addEventListener('close', function onClose() {
                            if (vibrationsOffDialog.returnValue == 'cancel') {
                                console.log("we got cancelled!");
                                vibrationSwitch.checked = true;
                                vibration = true
                            } else {
                                console.log("vibration now equals: " + vibration);
                                saveSettings();
                            }
                        });
                    } else {
                        console.log("vibration now equals: " + vibration);
                        saveSettings();
                    }
                }

                standbySwitch.oninput = function() {
                    standbyEnabled = this.checked;
                    if (standbyEnabled) {
                        // we just set it to true, need to ask in a dialog
                        standbyOnDialog.showModal();
                        standbyOnDialog.addEventListener('close', function onClose() {
                            if (standbyOnDialog.returnValue == 'cancel') {
                                console.log("we got cancelled!");
                                standbySwitch.checked = false;
                                standbyEnabled = false
                            } else {
                                console.log("standbyEnabled now equals: " + standbyEnabled);
                                saveSettings();
                            }
                        });
                    } else {
                        console.log("standbyEnabled now equals: " + standbyEnabled);
                        saveSettings();
                    }
                }

                doubleTapTimeoutSlider.oninput = function() {
                    doubleTapTimeout = parseInt(this.value, 10);
                    console.log("doubleTapTimeout now equals: " + doubleTapTimeout);
                    saveSettings();
                }

                sleepSelector.oninput = function() {
                    sleepAfterValue = parseInt(this.value, 10);
                    console.log("sleepAfterValue now equals: " + sleepAfterValue);
                    saveSettings();
                }

                autoCorrectionSwitch.oninput = function() {
                    autoCorrection = this.checked;
                    console.log("autoCorrection now equals: " + autoCorrection);
                    saveSettings();
                }

                mouseOnlySwitch.oninput = function() {
                    mouseOnly = this.checked;
                    console.log("mouseOnly now equals: " + mouseOnly);
                    if (mouseOnly) {
                        // we just set it to true, need to ask in a dialog
                        mouseOnlyDialog.showModal();
                        mouseOnlyDialog.addEventListener('close', function onClose() {
                            if (mouseOnlyDialog.returnValue == 'cancel') {
                                console.log("we got cancelled!");
                                mouseOnlySwitch.checked = false;
                                mouseOnly = false
                            } else {
                                keyboardOnlySwitch.checked = false;
                                keyboardOnly = false;
                            }
                            console.log(mouseOnlyDialog.returnValue + " button clicked");
                            console.log("keyboardOnly now equals: " + keyboardOnly);
                            mouseAndKeyboard = !(mouseOnly || keyboardOnly);
                            console.log("mouseandKeyboard now equals: " + mouseAndKeyboard);
                            mouseAndKeyboardSwitch.checked = mouseAndKeyboard;
                            saveSettings();
                        });
                    } else {
                        // just turned off mouseOnly - we turn on maouse and keyboard automatically
                        mouseAndKeyboard = !(mouseOnly || keyboardOnly);
                        mouseAndKeyboardSwitch.checked = mouseAndKeyboard;
                        saveSettings();
                    }
                }

                keyboardOnlySwitch.oninput = function() {
                    keyboardOnly = this.checked;
                    console.log("keyboardOnly now equals: " + keyboardOnly);
                    if (keyboardOnly) {
                        // we just set it to true, need to ask in a dialog
                        keyboardOnlyDialog.showModal();
                        keyboardOnlyDialog.addEventListener('close', function onClose() {
                            if (keyboardOnlyDialog.returnValue == 'cancel') {
                                console.log("we got cancelled!");
                                keyboardOnlySwitch.checked = false;
                                keyboardOnly = false
                            } else {
                                mouseOnlySwitch.checked = false;
                                mouseOnly = false;
                            }
                            console.log(keyboardOnlyDialog.returnValue + " button clicked");
                            console.log("mouseOnly now equals: " + mouseOnly);
                            mouseAndKeyboard = !(mouseOnly || keyboardOnly);
                            console.log("mouseandKeyboard now equals: " + mouseAndKeyboard);
                            mouseAndKeyboardSwitch.checked = mouseAndKeyboard;
                            saveSettings();
                        });
                    } else {
                        // just turned off keyboardeOnly - we turn on maouse and keyboard automatically
                        mouseAndKeyboard = !(mouseOnly || keyboardOnly);
                        mouseAndKeyboardSwitch.checked = mouseAndKeyboard;
                        saveSettings();
                    }
                }

                mouseAndKeyboardSwitch.oninput = function() {
                    mouseAndKeyboard = this.checked;
                    console.log("mouseAndKeyboard now equals: " + mouseAndKeyboard);
                    if (mouseAndKeyboard) {
                        keyboardOnlySwitch.checked = false;
                        keyboardOnly = false
                        mouseOnlySwitch.checked = false;
                        mouseOnly = false;
                        saveSettings();
                    } else {
                        // just turned off mouseAndKeyboard - we turn on maouseOnly automatically
                        mouseOnlySwitch.checked = true;
                        saveSettings();
                    }
                }

                mouseSensitivitySlider.oninput = function() {
                    mouseSensitivity = parseInt(this.value, 10);
                    console.log("mouseSensitivity now equals: " + mouseSensitivity);
                    saveSettings();
                }

                scrollSensitivitySlider.oninput = function() {
                    scrollSensitivity = parseInt(this.value, 10);
                    console.log("scrollSensitivity now equals: " + scrollSensitivity);
                    saveSettings();
                }

                scrollDirectionFlipSwitch.oninput = function() {
                    scrollDirectionFlip = this.checked;
                    console.log("scrollDirectionFlip now equals: " + scrollDirectionFlip);
                    saveSettings();
                }

                developerModeSwitch.oninput = function() {
                    developerMode = this.checked;
                    if (developerMode) {
                        // we just set it to true, need to ask in a dialog
                        developerModeDialog.showModal();
                        developerModeDialog.addEventListener('close', function onClose() {
                            if (developerModeDialog.returnValue == 'cancel') {
                                console.log("we got cancelled!");
                                developerModeSwitch.checked = false;
                                developerMode = false
                            } else {
                                developerModeChangedDialog.showModal();
                            }
                            console.log("developerMode now equals: " + developerMode);
                            saveSettings();
                        });

                    } else {
                        developerModeChangedDialog.showModal();
                        console.log("developerMode now equals: " + developerMode);
                        saveSettings();
                    }
                }

            }).catch (error => {
                disconnected();

                console.log('Argh! ' + error.message);
                console.log('it is all over now');
            });

        });

    </script>

    <script>
      // if('serviceWorker' in navigator) {
      //   navigator.serviceWorker.register('service-worker.js');
      // }
    </script>

  </body>
</html>
