<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">

    <title>Tap Manager</title>

    <style>
      html {
        font-family: sans-serif;
      }

      body {
        width: 50%;
        max-width: 800px;
        min-width: 480px;
        margin: 0 auto;
      }

    </style>
  </head>
  <body>
    <h1>We are going to connect to your Tap</h1>

    <p>When you press the button we will search for Tap devices nearby</p>

    <!-- <div class="form">
      <label for="macField">Enter a macId: </label>
      <input type="text" id="macField" class="macField">
      <input type="submit" value="Search for Taps" class="findTaps">
    </div> -->

    <button id="searchDevicesBtn">Search for Tap </button>

    <div id="notFound"> No devices found, please try again</div>

    <script>

        let DEVICE_INFORMATION = '0000180a-0000-1000-8000-00805f9b34fb';
        let FIRMWARE_REVISION_STRING = '00002a26-0000-1000-8000-00805f9b34fb';
        // Add a global error event listener early on in the page load, to help ensure that browsers
        // which don't support specific functionality still end up displaying a meaningful message.
        window.addEventListener('error', function(error) {
            if (ChromeSamples && ChromeSamples.setStatus) {
              console.error(error);
              ChromeSamples.setStatus(error.message + ' (Your browser may not support this feature.)');
              error.preventDefault();
            }
        });

        var notFoundTxt = document.getElementById('notFound');
        notFoundTxt.style.display = "none";

        var  searchBtn = document.getElementById('searchDevicesBtn')
        searchBtn.addEventListener('click', function() {
            notFoundTxt.style.display = "none";
            let filters = [];
            // this UUID is the specific TAP UUID
            filters.push({services: ['c3ff0001-1d8b-40fd-a56f-c7bd5d0f3370']});

            let optionalServices = [];
            optionalServices.push(DEVICE_INFORMATION);

            let options = {};
            options.filters = filters;
            options.optionalServices = optionalServices;

            console.log('Requesting TAP device...');

            navigator.bluetooth.requestDevice(options).then(device => {
                console.log('> Name:       ' + device.name);
                console.log('> Id:         ' + device.id);
                console.log('> Connected:  ' + device.gatt.connected);
                return device;
            // }).
            //
            // navigator.bluetooth.getDevices(options).then(devices => {
            //     console.log('we got here!');
            //     if (devices.length == 0) {
            //         console.log('got here - none found');
            //     }
            //     let i = 0;
            //
            //     while (i < devices.length) {
            //         console.log('We found a device!');
            //         console.log('> Name:       ' + devices[i].name);
            //         console.log('> Id:         ' + devices[i].id);
            //         console.log('> Connected:  ' + devices[i].gatt.connected);
            //         if (devices[i].name.startsWith("Tap")) {
            //             let connected = devices[i].gatt.connect();
            //             connected.then(server => {
            //                 console.log("Connected to device = " + server.device.name);
            //                 return server;
            //             }).catch (error => {
            //                 console.log("Error connecting: " + error);
            //             });
            //             // if we get here try the next
            //         }
            //         i++;
            //     }
            //     // so if we got here w got nothing to connect to
            //     console.log('found nothing at all to connect to!');
            //     notFoundTxt.style.display = "block";
            }).then (device => {
                console.log('Here we are connecting to ' + device.name);
                return device.gatt.connect();
            }).then (server => {
                console.log('Connected to device: ' + server.device.name);
                console.log('Getting device info service');
                return server.getPrimaryService(DEVICE_INFORMATION);
            }).then(service => {
                console.log('Getting firmware string characteristic');
                return service.getCharacteristic(FIRMWARE_REVISION_STRING);
            }).then (characteristic => {
                console.log('Reading characteristic info:');
                console.log('> Characteristic UUID:  ' + characteristic.uuid);
                console.log('> Broadcast:            ' + characteristic.properties.broadcast);
                console.log('> Read:                 ' + characteristic.properties.read);
                console.log('> Write w/o response:   ' +
                                characteristic.properties.writeWithoutResponse);
                console.log('> Write:                ' + characteristic.properties.write);
                console.log('> Notify:               ' + characteristic.properties.notify);
                console.log('> Indicate:             ' + characteristic.properties.indicate);
                console.log('> Signed Write:         ' +
                                characteristic.properties.authenticatedSignedWrites);
                console.log('> Queued Write:         ' + characteristic.properties.reliableWrite);
                console.log('> Writable Auxiliaries: ' +
                                characteristic.properties.writableAuxiliaries);
                return characteristic.readValue();
            }).then ( value => {
                var decoder = new TextDecoder("utf-8");
                let decoded = decoder.decode(value);
                // let stringValue = value.toString();
                console.log('> Firmware string is ' + decoded);
            }).catch (error => {
                notFoundTxt.style.display = "block";
                console.log('Argh! ' + error);
            });

        });

    </script>

    <script>
      // if('serviceWorker' in navigator) {
      //   navigator.serviceWorker.register('service-worker.js');
      // }
    </script>

  </body>
</html>
